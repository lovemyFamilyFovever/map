<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.2/dist/esri-leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

    <link rel="stylesheet" href="libs/search/leaflet-search.css">
    <script src="libs/search/leaflet-search.js"></script>
</head>

<body>
    <div id="map" style="height: 1080px"></div>
</body>
<script>

    // 添加底图
    const imageURL = 'http://t0.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=94062428027398766a1d0f3000b5dc6c'
    let osm = L.tileLayer(imageURL, { crs: L.CRS.EPSG3857, maxZoom: 18 });

    // 创建地图
    let map = L.map("map", {
        minZoom: 1, //最小缩放值
        maxZoom: 18, //最大缩放值
        zoom: 7, //初始缩放值
        zoomControl: true, //是否启用地图缩放控件
        attributionControl: false, //是否启用地图属性控件
    }).setView([33.523079, 116.477051]).addLayer(osm);


    //添加矢量标记
    var url1 = 'http://t0.tianditu.gov.cn/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=94062428027398766a1d0f3000b5dc6c'
    L.tileLayer(url1, {
        maxZoom: 18,
        interactive: true
    }).addTo(map)

    //添加arcgis server图层
    let dynamicMapLayer = L.esri.dynamicMapLayer({
        url: 'https://mapservice.tdtah.cn/server1/rest/services/AHDISA/MapServer',
        layer: [0]
    }).addTo(map);


    //地图点击事件
    map.on('click', function (e) {
        let layer = e.target;

        dynamicMapLayer.bindPopup(function (err, featureCollection, response) {
            var count = featureCollection.features.length;
            return (count) ? count + ' features' : false;
        });

        // L.esri.query({
        //     url: "https://mapservice.tdtah.cn/server1/rest/services/shidi/MapServer/0"
        // }).where("1=1")
        //     .run(function (error, result) {
        //         console.log(result.features);
        //         result.features.forEach(function (result) {
        //             //后续处理result 为 geojson
        //         })
        //     })

        // 获取点击位置的坐标
        console.log(e.latlng)

        var marker = L.marker(e.latlng).addTo(map);
        marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();

        var popup = L.popup();
        popup
            .setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(map);
    })
</script>

</html>